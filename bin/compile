#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

indent() {
    echo "     $*" || true
}

VENDOR_DIR=$BUILD_DIR/vendor
ORACLE_DIR=$VENDOR_DIR/oracle
INSTANTCLIENT_DIR=$ORACLE_DIR/instantclient_12_2
PROFILE_D_DIR=$BUILD_DIR/.profile.d

#linux x64
#BASIC_FILENAME=instantclient-basic-linux-12.2.0.1.0.zip
#SDK_FILENAME=instantclient-sdk-linux-12.2.0.1.0.zip

#linux x64
BASIC_FILENAME=instantclient-basic-linux.x64-12.2.0.1.0.zip
SDK_FILENAME=instantclient-sdk-linux.x64-12.2.0.1.0.zip

# macos
#BASIC_FILENAME=instantclient-basic-macos.x64-12.1.0.2.0.zip
#SDK_FILENAME=instantclient-sdk-macos.x64-12.1.0.2.0.zip

MIRROR=https://sarkel.usermd.net/

if [ ! -e $CACHE_DIR/$BASIC_FILENAME ]
then
    indent "Downloading $BASIC_FILENAME..."
    curl -# -o $CACHE_DIR/$BASIC_FILENAME $MIRROR/$BASIC_FILENAME
fi

if [ ! -e $CACHE_DIR/$SDK_FILENAME ]
then
    indent "Downloading $SDK_FILENAME..."
    curl -# -o $CACHE_DIR/$SDK_FILENAME $MIRROR/$SDK_FILENAME
fi

mkdir -p $ORACLE_DIR
indent "Extracting $BASIC_FILENAME..."
unzip -qq $CACHE_DIR/$BASIC_FILENAME -d $ORACLE_DIR
indent "Extracting $SDK_FILENAME..."
unzip -qq $CACHE_DIR/$SDK_FILENAME -d $ORACLE_DIR

export OCI_LIB_DIR=$INSTANTCLIENT_DIR
export OCI_INC_DIR=$INSTANTCLIENT_DIR/sdk/include

indent "Symlinking libclntsh.so..."
THIS_DIR=`pwd`
cd $INSTANTCLIENT_DIR
ln -s libclntsh.so.12.1 libclntsh.so
#ln -s libclntsh.dylib.12.1 libclntsh.dylib
cd $THIS_DIR

indent "Installing node-oracledb"
THIS_DIR=`pwd`
cd $BUILD_DIR
npm install oracledb --save
cd $THIS_DIR

indent "Saving environment setup script..."
mkdir -p $PROFILE_D_DIR
cat << EOF > $PROFILE_D_DIR/oracle.sh
#!/usr/bin/env bash
export LD_LIBRARY_PATH="$HOME/vendor/oracle/instantclient_12_2:$HOME/.apt/lib/x86_64-linux-gnu:\$LD_LIBRARY_PATH"
export OCI_LIB_DIR="$HOME/vendor/oracle/instantclient_12_2"
export OCI_INC_DIR="$HOME/vendor/oracle/instantclient_12_2/sdk/include"
EOF

indent "Done."